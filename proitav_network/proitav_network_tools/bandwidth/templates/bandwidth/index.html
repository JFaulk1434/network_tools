{% extends 'base.html' %}

{% block content %}
<h2>Speed Test</h2>
<form method="post" id="speedtest-form">
    {% csrf_token %}
    <input type="submit" value="Test Speed">
</form>

<div id="loading-message" style="display: none;">Running speed test...</div>

{% if results %}
<h3>Speed Test Results</h3>
<table>
    <tr>
        <th>Download</th>
        <th>Upload</th>
        <th>Ping</th>
    </tr>
    <tr>
        <td>{{ results.Download }}</td>
        <td>{{ results.Upload }}</td>
        <td>{{ results.Ping }}</td>
    </tr>
</table>
<h3>Server Info</h3>
<table>
    <tr>
        <th>Name</th>
        <th>Host</th>
        <th>Country</th>
    </tr>
    <tr>
        <td>{{ server.Name }}</td>
        <td>{{ server.Host }}</td>
        <td>{{ server.Country }}</td>
    </tr>
</table>
<h3>Client Info</h3>
<table>
    <tr>
        <th>IP</th>
        <th>ISP</th>
        <th>ISP Rating</th>
        <th>Country</th>
    </tr>
    <tr>
        <td>{{ client.IP }}</td>
        <td>{{ client.ISP }}</td>
        <td>{{ client.ISPRating }}</td>
        <td>{{ client.Country }}</td>
    </tr>
</table>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
    document.getElementById('speedtest-form').addEventListener('submit', function (event) {
        event.preventDefault();
        document.getElementById('loading-message').style.display = 'block';

        // AJAX request to actually submit the form without refreshing the page
        var xhr = new XMLHttpRequest();
        xhr.open(this.method, this.action);
        xhr.setRequestHeader("X-Requested-With", "XMLHttpRequest");
        xhr.setRequestHeader("X-CSRFToken", this.querySelector('[name=csrfmiddlewaretoken]').value);

        xhr.onload = function () {
            if (xhr.status >= 200 && xhr.status < 400) {
                // Success! Replace the whole body content with new one. You might want to change this.
                document.body.innerHTML = xhr.responseText;
            } else {
                // We reached our target server, but it returned an error. You might want to handle this.
            }
        };

        xhr.onerror = function () {
            // There was a connection error of some sort. You might want to handle this.
        };

        xhr.send(new FormData(this));
    });
</script>
{% endblock %}